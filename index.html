<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—¥æ—¥ Hibi - Daily Japanese</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FDFCFA">
    <meta name="application-name" content="æ—¥æ—¥ Hibi">
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/7864/7864294.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;500;700&family=Shippori+Mincho:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        muji: { bg: '#FDFCFA', card: '#FFFFFF', text: '#373C38', sub: '#9CA3AF', green: '#8F9E8B', brown: '#8D7462', red: '#D99386', gold: '#D4AF37', vermilion: '#E34234' }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'], rounded: ['"Zen Maru Gothic"', 'sans-serif'], serif: ['"Shippori Mincho"', 'serif'],
                    },
                    boxShadow: { soft: '0 8px 30px -6px rgba(0, 0, 0, 0.04)', float: '0 10px 40px -10px rgba(0, 0, 0, 0.08)' },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)', 'float': 'float 3s ease-in-out infinite', 'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both', 'unfold': 'unfold 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0) rotate(-1deg)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0) rotate(2deg)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0) rotate(-4deg)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0) rotate(4deg)' } },
                        unfold: { '0%': { transform: 'scaleY(0.1) scaleX(0.8)', opacity: '0' }, '100%': { transform: 'scaleY(1) scaleX(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FDFCFA; color: #373C38; -webkit-font-smoothing: antialiased; overscroll-behavior-y: none; touch-action: pan-y; }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .perspective-1000 { perspective: 1000px; } .preserve-3d { transform-style: preserve-3d; } .backface-hidden { backface-visibility: hidden; } .rotate-y-180 { transform: rotateY(180deg); }
        .pt-safe-top { padding-top: max(16px, env(safe-area-inset-top)); } .pb-safe-bottom { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
        * { -webkit-tap-highlight-color: transparent; } .select-none { user-select: none; -webkit-user-select: none; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 0.15em; }
        button:active { transform: scale(0.96); }
        .toggle-checkbox:checked { right: 0; border-color: #8F9E8B; } .toggle-checkbox:checked + .toggle-label { background-color: #8F9E8B; }
        .washi-paper { background-color: #ffffff; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E"); }
    </style>
</head>
<body class="h-[100dvh] w-full overflow-hidden flex flex-col font-sans select-none">

    <!-- Loading Screen -->
    <div id="app-loading" class="fixed inset-0 bg-muji-bg z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <h1 class="text-3xl font-rounded font-bold text-muji-text tracking-widest animate-pulse">æ—¥æ—¥</h1>
        <p class="text-xs text-muji-sub mt-2 tracking-wide">è¼‰å…¥ä¸­...</p>
    </div>

    <!-- Init Screen (Auth) -->
    <div id="auth-screen" class="fixed inset-0 bg-muji-bg z-[90] flex flex-col items-center justify-center transition-opacity duration-500 p-6 hidden">
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-rounded font-bold text-muji-text tracking-widest mb-2">æ—¥æ—¥</h1>
            <span class="text-sm text-muji-sub tracking-wider">Hibi Daily Japanese</span>
        </div>
        <div class="w-full max-w-xs bg-white p-6 rounded-2xl shadow-float border border-gray-100">
            <div class="mb-4 text-center">
                <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl">ğŸ‘‹</div>
                <h2 class="text-lg font-bold text-muji-text">æ­¡è¿å›ä¾†</h2>
                <p class="text-xs text-muji-sub mt-1">è«‹è¼¸å…¥æš±ç¨±ä»¥åŒæ­¥é›²ç«¯é€²åº¦</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="input-nickname" placeholder="æ‚¨çš„æš±ç¨± (ä¾‹å¦‚: Alex)" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-muji-green text-center font-medium">
                <button onclick="handleLogin()" class="w-full py-3 bg-muji-text text-white rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <i data-lucide="log-in" class="w-4 h-4"></i> é–‹å§‹å­¸ç¿’
                </button>
            </div>
            <p class="mt-4 text-[10px] text-center text-gray-400"><i data-lucide="cloud" class="w-3 h-3 inline mr-1"></i>æ”¯æ´ Google Cloud åŒæ­¥</p>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden h-full flex flex-col">
        <!-- Header -->
        <header class="flex-none px-6 pt-safe-top py-4 flex justify-between items-center bg-muji-bg/95 backdrop-blur-sm z-10 border-b border-muji-border/50 sticky top-0 transition-all duration-500">
            <div onclick="showProfile(); vibrate(5)" class="active:opacity-70 transition-opacity cursor-pointer">
                <div class="flex items-center gap-2">
                    <h1 class="text-xl font-rounded font-bold text-muji-text tracking-wide">æ—¥æ—¥</h1>
                    <span id="user-badge" class="text-[10px] px-2 py-0.5 bg-gray-100 text-gray-500 rounded-full">Guest</span>
                </div>
                <div class="flex items-center gap-3 mt-1">
                    <div class="flex items-center gap-1 text-muji-brown bg-muji-brown/10 px-2 py-0.5 rounded-md"><i data-lucide="flame" class="w-3 h-3"></i><span id="header-streak" class="text-xs font-bold">0</span></div>
                    <div class="flex items-center gap-1 text-muji-green bg-muji-green/10 px-2 py-0.5 rounded-md"><i data-lucide="star" class="w-3 h-3"></i><span id="header-points" class="text-xs font-bold">0</span></div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                 <button onclick="addToCalendar(); vibrate(5)" class="flex flex-col items-center justify-center px-2 py-1 rounded-lg text-muji-sub hover:bg-gray-50 active:bg-gray-100 transition-colors">
                    <i data-lucide="bell" class="w-5 h-5 mb-0.5"></i>
                    <span class="text-[9px] font-medium tracking-wide">æé†’</span>
                 </button>
                 <button onclick="showOmikuji(); vibrate(5)" class="flex flex-col items-center justify-center px-2 py-1 rounded-lg text-muji-sub hover:bg-gray-50 active:bg-gray-100 transition-colors">
                    <i data-lucide="gift" class="w-5 h-5 mb-0.5"></i>
                    <span class="text-[9px] font-medium tracking-wide">æ¯æ—¥ç°½</span>
                 </button>
                 <button onclick="showSettings(); vibrate(5)" class="flex flex-col items-center justify-center px-2 py-1 rounded-lg text-muji-sub hover:bg-gray-50 active:bg-gray-100 transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 mb-0.5"></i>
                    <span class="text-[9px] font-medium tracking-wide">è¨­å®š</span>
                 </button>
                 <div class="relative w-10 h-10 flex items-center justify-center cursor-pointer active:scale-90 transition-transform ml-1" onclick="showShareModal(); vibrate(10)">
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36"><path class="text-gray-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" /><path id="goal-progress-ring" class="text-muji-green transition-all duration-1000 ease-out" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" /></svg>
                    <div class="absolute text-[10px] font-bold text-muji-sub" id="goal-text">0/5</div>
                 </div>
            </div>
        </header>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar relative w-full max-w-md mx-auto" id="app-container">
            <!-- Tab 1: æ—… (Travel) -->
            <div id="view-travel" class="view-section px-6 py-4 space-y-6 animate-fade-in pb-32">
                <div class="text-center mb-6 relative">
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-muji-green/10 mb-2"><span class="text-muji-green text-xs font-bold tracking-widest">TRAVEL</span><span class="w-1 h-1 rounded-full bg-muji-green"></span><span id="count-travel" class="text-muji-green text-[10px] font-medium">-- å¥</span></div>
                    <h2 id="card-category" class="text-lg font-rounded text-muji-text">è¼‰å…¥ä¸­...</h2>
                    <button id="btn-autoplay" onclick="toggleAutoPlay()" class="absolute right-0 top-2 p-3 rounded-full border border-muji-border text-muji-sub hover:text-muji-green hover:bg-white hover:shadow-sm transition-all flex items-center gap-1 active:scale-95">
                        <div class="relative w-4 h-4"><div id="wrapper-icon-play" class="absolute inset-0 transition-opacity duration-200"><i data-lucide="headphones" class="w-4 h-4"></i></div><div id="wrapper-icon-pause" class="absolute inset-0 transition-opacity duration-200 opacity-0"><i data-lucide="pause" class="w-4 h-4"></i></div></div><span class="text-[10px] hidden sm:inline" id="text-autoplay">è½æµ</span>
                    </button>
                </div>
                <div id="flashcard-container" class="perspective-1000 w-full h-80 cursor-pointer group relative" onclick="flipCard(this)">
                    <div id="hint-left" class="absolute inset-y-0 left-4 flex items-center opacity-0 transition-opacity z-10 pointer-events-none"><div class="bg-gray-300/80 text-white p-3 rounded-full shadow-lg backdrop-blur-sm"><i data-lucide="x" class="w-8 h-8"></i></div></div>
                    <div id="hint-right" class="absolute inset-y-0 right-4 flex items-center opacity-0 transition-opacity z-10 pointer-events-none"><div class="bg-muji-green/80 text-white p-3 rounded-full shadow-lg backdrop-blur-sm"><i data-lucide="check" class="w-8 h-8"></i></div></div>
                    <div class="card-inner relative w-full h-full transition-all duration-500 preserve-3d shadow-soft rounded-2xl bg-white">
                        <div class="absolute w-full h-full backface-hidden bg-muji-card rounded-2xl flex flex-col items-center justify-center p-6 border border-muji-border">
                            <span id="card-desc" class="text-sm text-muji-sub mb-4">...</span><h3 id="card-jp" class="text-3xl font-bold text-muji-text mb-2 text-center leading-relaxed">...</h3>
                            <div class="mt-6 px-6 py-2.5 rounded-full bg-muji-bg text-muji-green animate-float flex items-center gap-2 shadow-sm border border-muji-green/20"><span class="text-sm font-bold tracking-widest">è½ç­”æ¡ˆ</span><i data-lucide="rotate-cw" class="w-4 h-4"></i></div>
                        </div>
                        <div class="absolute w-full h-full backface-hidden bg-muji-text text-white rounded-2xl rotate-y-180 flex flex-col items-center justify-center p-6">
                            <p id="card-romaji" class="text-2xl font-bold mb-2 text-center transition-opacity duration-300">...</p><p id="card-kana" class="text-sm text-gray-300 mb-2 text-center">...</p><p id="card-sorami" class="text-xs text-muji-green font-medium mb-6 tracking-wide opacity-90 text-center">...</p>
                            <button onclick="playAudioCurrentCard(event)" class="flex items-center gap-2 px-6 py-3 rounded-full bg-white/20 hover:bg-white/30 transition-all backdrop-blur-sm active:scale-95"><i data-lucide="volume-2" class="w-5 h-5"></i><span class="text-sm">æ’­æ”¾</span></button>
                        </div>
                    </div>
                </div>
                <div class="flex justify-center gap-8 mt-6"><button class="w-16 h-16 rounded-full border border-muji-border bg-white flex items-center justify-center text-gray-300 hover:text-muji-sub shadow-sm active:scale-90 transition-transform" onclick="handleCardResult(false); vibrate(10)"><i data-lucide="x" class="w-8 h-8"></i></button><button class="w-16 h-16 rounded-full bg-muji-text text-white flex items-center justify-center shadow-float active:scale-90 transition-transform" onclick="handleCardResult(true); vibrate(15)"><i data-lucide="check" class="w-8 h-8"></i></button></div>
                <div class="mt-8"><h3 class="text-sm font-bold text-muji-sub mb-3 uppercase tracking-wider">ç›¸é—œå–®å­—</h3><div id="vocab-list" class="bg-white rounded-xl p-4 shadow-sm border border-muji-border space-y-3"></div></div>
            </div>

            <!-- Tab 2: ç¿’ (Practice) -->
            <div id="view-practice" class="view-section hidden px-6 py-4 space-y-6 pb-32">
                <div class="text-center mb-6"><div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-muji-brown/10 mb-2"><span class="text-muji-brown text-xs font-bold tracking-widest">PRACTICE</span><span class="w-1 h-1 rounded-full bg-muji-brown"></span><span id="count-practice" class="text-muji-brown text-[10px] font-medium">-- æƒ…å¢ƒ</span></div><h2 id="practice-title" class="text-lg font-rounded text-muji-text">...</h2><p id="practice-desc" class="text-xs text-muji-sub mt-1">...</p><button onclick="nextPractice(); vibrate(5)" class="mt-2 text-[10px] text-muji-sub border border-muji-border px-3 py-1.5 rounded-full flex items-center gap-1 mx-auto hover:bg-gray-50 active:bg-gray-100"><i data-lucide="refresh-ccw" class="w-3 h-3"></i> åˆ‡æ›æƒ…å¢ƒ</button></div>
                <div class="space-y-4 mb-20" id="chat-container">
                    <div class="flex gap-3 animate-slide-up"><div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-sm font-bold text-gray-500 flex-shrink-0">å½¼</div><div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-muji-border max-w-[85%]"><p id="practice-npc-text" class="text-base text-muji-text font-medium mb-1">...</p><p id="practice-npc-mean" class="text-xs text-muji-sub mb-2">...</p><button onclick="playAudio(document.getElementById('practice-npc-text').innerText, event)" class="text-muji-green hover:text-muji-text active:scale-110 transition-transform p-2 -ml-2"><i data-lucide="volume-2" class="w-5 h-5"></i></button></div></div>
                    <div class="flex justify-end gap-3 animate-slide-up" style="animation-delay: 0.1s;"><div class="bg-muji-green/10 p-4 rounded-2xl rounded-tr-none border border-muji-green/20 max-w-[85%] text-right w-full"><p class="text-xs text-muji-sub mb-1">ç›®æ¨™å›ç­”</p><p id="practice-target-text" class="text-lg text-muji-text font-bold leading-relaxed">...</p><p id="practice-target-mean" class="text-[10px] text-muji-sub mb-3 opacity-70">...</p><div class="mt-3 flex justify-end gap-2 flex-wrap"><button onclick="playAudio(document.getElementById('practice-target-text').innerText, event)" class="px-4 py-2.5 bg-white rounded-full text-xs shadow-sm flex items-center gap-1 text-muji-text border border-muji-border active:bg-gray-50"><i data-lucide="ear" class="w-3 h-3"></i> ç¯„ä¾‹</button><button id="btn-record" onclick="toggleRecording(); vibrate(10)" class="px-5 py-2.5 bg-muji-green text-white rounded-full text-xs shadow-sm flex items-center gap-1 transition-all active:scale-95 active:bg-green-700"><i data-lucide="mic" class="w-3 h-3"></i> <span id="btn-record-text">æŒ‰æ­¤èªªè©±</span></button></div></div><div class="w-10 h-10 rounded-full bg-muji-brown text-white flex items-center justify-center text-sm font-bold flex-shrink-0">æˆ‘</div></div>
                    <div id="feedback-area" class="hidden p-4 bg-gray-50 rounded-xl text-center text-xs text-muji-sub border border-dashed border-gray-300 transition-all"><p id="feedback-text" class="mb-1">...</p><p id="transcript-text" class="text-muji-text font-bold text-base min-h-[1.5em]"></p></div>
                </div>
            </div>

            <!-- Tab 3: ç£¨ (Master) -->
            <div id="view-master" class="view-section hidden px-6 py-4 space-y-6 pb-32">
                 <div class="text-center mb-4"><div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-muji-text/10 mb-2"><span class="text-muji-text text-xs font-bold tracking-widest">MASTER</span><span class="w-1 h-1 rounded-full bg-muji-text"></span><span id="count-master" class="text-muji-text text-[10px] font-medium">-- é¡Œ</span></div><h2 class="text-lg font-rounded text-muji-text">æ•¬èªèˆ‡å¸¸é«”çš„åˆ‡æ›</h2></div>
                <div class="relative"><i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i><input type="text" id="master-search" placeholder="æœå°‹æƒ…å¢ƒ..." oninput="renderMasterQuiz()" class="w-full bg-gray-50 border border-gray-100 rounded-xl py-2.5 pl-10 pr-4 text-sm focus:outline-none focus:border-muji-text transition-colors"></div>
                <div id="quiz-container" class="space-y-6 animate-fade-in"></div>
            </div>
        </main>

        <!-- Nav -->
        <nav class="flex-none bg-white border-t border-muji-border pb-safe-bottom z-20 shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
            <div class="flex justify-around items-center h-16">
                <button onclick="switchTab('travel'); vibrate(5)" class="nav-btn active group flex flex-col items-center justify-center w-full h-full space-y-1 active:bg-gray-50" data-target="view-travel"><i data-lucide="map" class="w-6 h-6 transition-colors text-muji-green"></i><span class="text-[10px] font-medium tracking-wide transition-colors text-muji-green">æ—… Tabi</span></button>
                <button onclick="switchTab('practice'); vibrate(5)" class="nav-btn group flex flex-col items-center justify-center w-full h-full space-y-1 active:bg-gray-50" data-target="view-practice"><i data-lucide="message-circle" class="w-6 h-6 transition-colors text-muji-sub group-hover:text-muji-brown"></i><span class="text-[10px] font-medium tracking-wide transition-colors text-muji-sub group-hover:text-muji-brown">ç¿’ Narau</span></button>
                <button onclick="switchTab('master'); vibrate(5)" class="nav-btn group flex flex-col items-center justify-center w-full h-full space-y-1 active:bg-gray-50" data-target="view-master"><i data-lucide="sparkles" class="w-6 h-6 transition-colors text-muji-sub group-hover:text-muji-text"></i><span class="text-[10px] font-medium tracking-wide transition-colors text-muji-sub group-hover:text-muji-text">ç£¨ Migaku</span></button>
            </div>
        </nav>

        <!-- Modals -->
        <div id="bigtext-modal" class="fixed inset-0 bg-white z-[60] flex flex-col items-center justify-center p-6 opacity-0 pointer-events-none transition-opacity duration-300"><button onclick="closeBigText()" class="absolute top-6 right-6 p-3 bg-gray-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button><p class="text-sm text-muji-sub mb-4 tracking-widest">è«‹å±•ç¤ºçµ¦å°æ–¹çœ‹</p><h2 id="bigtext-content" class="text-5xl font-bold text-muji-text text-center leading-snug break-words">...</h2></div>

        <div id="settings-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 p-6">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl relative overflow-hidden transform scale-95 transition-transform" id="settings-content">
                <button onclick="closeSettings()" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-600 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                <h3 class="text-xl font-bold text-muji-text mb-6">è¨­å®š</h3>
                <div class="space-y-6">
                    <div class="flex items-center justify-between"><span class="text-sm font-medium text-muji-text">é¡¯ç¤ºç¾…é¦¬æ‹¼éŸ³</span><div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" name="toggle" id="toggle-romaji" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 transition-all duration-300 top-0 left-0" onclick="toggleRomajiSetting()"/><label for="toggle-romaji" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label></div></div>
                    <div class="space-y-2"><div class="flex justify-between text-sm font-medium text-muji-text"><span>èªéŸ³é€Ÿåº¦</span><span id="speed-val">0.65</span></div><input type="range" min="0.5" max="1.0" step="0.05" id="speed-slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-muji-green" oninput="updateSpeed(this.value)"></div>
                    <div class="pt-4 border-t border-gray-100 space-y-3"><h4 class="text-xs font-bold text-muji-sub uppercase tracking-widest">è³‡æ–™ç®¡ç†</h4><button onclick="exportData()" class="w-full py-2 border border-muji-border rounded-lg text-sm text-muji-text flex items-center justify-center gap-2"><i data-lucide="download" class="w-4 h-4"></i> å‚™ä»½é€²åº¦</button><button onclick="importData()" class="w-full py-2 border border-muji-border rounded-lg text-sm text-muji-text flex items-center justify-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i> é‚„åŸé€²åº¦</button></div>
                </div>
            </div>
        </div>

        <div id="profile-modal" class="fixed inset-0 bg-white z-[55] flex flex-col opacity-0 pointer-events-none transition-opacity duration-300 overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold text-muji-text">å­¸ç¿’æˆå°±</h2><button onclick="closeProfile()" class="p-2 bg-gray-100 rounded-full"><i data-lucide="x" class="w-6 h-6"></i></button></div>
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <div class="bg-orange-50 p-4 rounded-2xl text-center"><i data-lucide="flame" class="w-8 h-8 text-orange-400 mx-auto mb-2"></i><div class="text-2xl font-bold text-muji-text" id="profile-streak">0</div><div class="text-xs text-muji-sub">é€£çºŒå¤©æ•¸</div></div>
                    <div class="bg-blue-50 p-4 rounded-2xl text-center"><i data-lucide="award" class="w-8 h-8 text-blue-400 mx-auto mb-2"></i><div class="text-2xl font-bold text-muji-text" id="profile-total">0</div><div class="text-xs text-muji-sub">å·²ç†Ÿè¨˜å–®å­—</div></div>
                </div>
                <h3 class="text-lg font-bold text-muji-text mb-4">å¾½ç« ç‰†</h3><div class="grid grid-cols-3 gap-3 mb-8" id="badge-container"></div>
                <h3 class="text-lg font-bold text-muji-text mb-4">æœ¬é€±æ’è¡Œæ¦œ</h3><div class="bg-gray-50 rounded-2xl p-4 space-y-4" id="leaderboard-list"></div>
            </div>
        </div>

        <div id="share-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 p-6">
            <div class="bg-white rounded-3xl w-full max-w-sm p-0 shadow-2xl transform scale-90 transition-transform duration-300 flex flex-col relative overflow-hidden" id="share-modal-content">
                <button onclick="closeShareModal()" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-600 active:bg-gray-100 rounded-full z-10 bg-white/50 backdrop-blur-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div id="share-card-container" class="w-full aspect-square bg-gray-100 relative"><canvas id="share-canvas" width="600" height="600" class="w-full h-full object-cover"></canvas><div id="loading-canvas" class="absolute inset-0 flex items-center justify-center text-muji-sub bg-white">è£½ä½œå¡ç‰‡ä¸­...</div></div>
                <div class="p-6"><h3 class="text-xl font-bold text-muji-text mb-1" id="share-title">ä»Šæ—¥æˆå°±</h3><div class="grid grid-cols-2 gap-3 mt-4"><button onclick="downloadShareImage()" class="py-3 bg-gray-100 text-muji-text rounded-xl font-medium shadow-sm active:bg-gray-200 transition-colors flex items-center justify-center gap-2 text-sm"><i data-lucide="download" class="w-4 h-4"></i> å„²å­˜</button><button onclick="shareProgress()" class="py-3 bg-muji-text text-white rounded-xl font-medium shadow-lg hover:bg-gray-800 active:scale-95 transition-transform flex items-center justify-center gap-2 text-sm"><i data-lucide="share-2" class="w-4 h-4"></i> åˆ†äº«</button></div></div>
            </div>
        </div>

        <div id="omikuji-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center opacity-0 pointer-events-none transition-all duration-500">
            <div id="omikuji-box-state" class="flex flex-col items-center text-center cursor-pointer transition-all duration-300" onclick="drawOmikuji()">
                <div id="omikuji-shaker" class="w-32 h-64 bg-muji-vermilion rounded-lg relative flex flex-col items-center justify-between py-4 shadow-2xl border-4 border-red-800"><div class="w-24 h-4 bg-black/20 rounded-full"></div><div class="text-white font-serif vertical-text text-3xl font-bold tracking-widest opacity-90">å¾¡ç¥ç±¤</div><div class="w-24 h-4 bg-black/20 rounded-full"></div><div class="absolute -top-3 w-8 h-4 bg-black rounded-full"></div></div><p class="mt-8 text-white font-bold text-lg animate-pulse tracking-widest">é»æ“Šç±¤ç­’æ±‚ç±¤</p>
            </div>
            <div id="omikuji-result-state" class="hidden washi-paper w-[85%] max-w-sm p-1 shadow-2xl transform scale-90 opacity-0 transition-all duration-1000 origin-top" style="min-height: 480px;">
                <div class="h-full border-2 border-muji-vermilion p-6 flex flex-col items-center text-center relative">
                    <div class="text-muji-vermilion mb-4 opacity-50"><i data-lucide="flower" class="w-6 h-6"></i></div><h3 class="text-lg text-muji-text font-serif tracking-widest mb-6 border-b border-gray-200 pb-2 w-full">æ—¥æ—¥é‹å‹¢</h3><div class="flex-1 flex justify-center items-center py-4"><p id="omikuji-text" class="text-5xl font-serif font-bold text-muji-vermilion vertical-text leading-tight drop-shadow-sm">å¤§å‰</p></div><div class="w-full bg-gray-50 p-4 rounded-sm my-6 border border-gray-100"><p id="omikuji-quote" class="text-sm text-muji-text font-serif leading-loose tracking-wide">ä¸€æœŸä¸€ä¼š</p></div><div class="flex justify-between w-full text-[10px] text-muji-sub border-t border-gray-200 pt-3"><div class="flex flex-col items-center"><span class="mb-1">å¹¸é‹è‰²</span><span id="omikuji-color" class="font-bold text-muji-text">æœ±ç´…</span></div><div class="flex flex-col items-center"><span class="mb-1">å¹¸é‹ç‰©</span><span id="omikuji-item" class="font-bold text-muji-text">æ‰‹å¸•</span></div></div><button onclick="closeOmikuji()" class="absolute -bottom-16 text-white border border-white/50 px-6 py-2 rounded-full hover:bg-white hover:text-muji-text transition-colors">æ”¶ä¸‹ç¥ç¦</button>
                </div>
            </div>
        </div>

        <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full text-sm font-medium opacity-0 transition-all duration-300 pointer-events-none z-[99] shadow-float translate-y-[-10px] flex items-center gap-2 backdrop-blur-md"><span>Message</span></div>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Data (Extended)
        const DB = {
            travel: [
                { id: 1, jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Sumimasen", kana: "ã™ã¿ã¾ã›ã‚“", sorami: "è˜‡å’ªåª½ç·š", desc: "ä¸å¥½æ„æ€ / è«‹å•", category: "åŸºæœ¬", vocab: [{ jp: "ã¯ã„", reading: "Hai", mean: "æ˜¯" }] },
                { id: 2, jp: "ã‚ã‚ŠãŒã¨ã†", romaji: "Arigatou", kana: "ã‚ã‚ŠãŒã¨ã†", sorami: "é˜¿é‡Œå˜å¤š", desc: "è¬è¬", category: "åŸºæœ¬", vocab: [{ jp: "ã„ã„ãˆ", reading: "Iie", mean: "ä¸å®¢æ°£" }] },
                { id: 3, jp: "ã”ã‚ã‚“ãªã•ã„", romaji: "Gomennasai", kana: "ã”ã‚ã‚“ãªã•ã„", sorami: "ç‹—å¦¹é‚£è³½", desc: "å°ä¸èµ·", category: "åŸºæœ¬", vocab: [{ jp: "å¤§ä¸ˆå¤«", reading: "Daijoubu", mean: "æ²’é—œä¿‚" }] },
                { id: 4, jp: "ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Kore o onegaishimasu", kana: "ã“ã‚Œ ã‚’ ãŠã­ãŒã„ã—ã¾ã™", sorami: "å£å…§ å–” æ­å…§è©²æ´—åª½è˜‡", desc: "éº»ç…©çµ¦æˆ‘é€™å€‹", category: "è³¼ç‰©", vocab: [{ jp: "ã“ã‚Œ", reading: "Kore", mean: "é€™å€‹" }] },
                { id: 5, jp: "ã„ãã‚‰ã§ã™ã‹", romaji: "Ikura desu ka", kana: "ã„ãã‚‰ ã§ã™ ã‹", sorami: "ä»¥å“­å•¦", desc: "è«‹å•å¤šå°‘éŒ¢ï¼Ÿ", category: "è³¼ç‰©", vocab: [{ jp: "å††", reading: "En", mean: "æ—¥åœ“" }] },
                { id: 6, jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹", romaji: "Toire wa doko desu ka", kana: "ã¨ã„ã‚Œ ã¯ ã©ã“ ã§ã™ ã‹", sorami: "æ‹–è¡£è•¾ å“‡ è±†å£", desc: "å»æ‰€åœ¨å“ªè£¡ï¼Ÿ", category: "ç·Šæ€¥", vocab: [{ jp: "å ´æ‰€", reading: "Basho", mean: "åœ°é»" }] },
                { id: 7, jp: "å†™çœŸã„ã„ã§ã™ã‹", romaji: "Shashin ii desu ka", kana: "ã—ã‚ƒã—ã‚“ ã„ã„ ã§ã™ ã‹", sorami: "çå¿ƒ ä¸€ å¾—æ­» å¡", desc: "å¯ä»¥æ‹ç…§å—ï¼Ÿ", category: "è§€å…‰", vocab: [{ jp: "å†™çœŸ", reading: "Shashin", mean: "ç…§ç‰‡" }] },
                { id: 8, jp: "ç¾å‘³ã—ã„ã§ã™", romaji: "Oishii desu", kana: "ãŠã„ã—ã„ ã§ã™", sorami: "æ­ä¸€ä¿‚ å¾—æ­»", desc: "å¾ˆå¥½åƒ", category: "é¤å»³", vocab: [{ jp: "å‘³", reading: "Aji", mean: "å‘³é“" }] },
                { id: 9, jp: "è‹±èªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ï¼Ÿ", romaji: "Eigo menyuu wa", kana: "ãˆã„ã” ã‚ã«ã‚…ãƒ¼ ã¯", sorami: "A-Go æ¢…ç´ å“‡", desc: "æœ‰è‹±æ–‡èœå–®å—ï¼Ÿ", category: "é¤å»³", vocab: [{ jp: "è‹±èª", reading: "Eigo", mean: "è‹±æ–‡" }] },
                { id: 10, jp: "ãŠæ°´ãã ã•ã„", romaji: "Omizu kudasai", kana: "ãŠã¿ãš ãã ã•ã„", sorami: "æ­å’ªèŒ² å“­æ‰“è³½", desc: "è«‹çµ¦æˆ‘æ°´", category: "é¤å»³", vocab: [{ jp: "æ°´", reading: "Mizu", mean: "æ°´" }] },
                { id: 11, jp: "è·ç‰©ãŒå‡ºã¦ãã¾ã›ã‚“", romaji: "Nimotsu ga dete kimasen", kana: "ã«ã‚‚ã¤ ãŒ ã§ã¦ ãã¾ã›ã‚“", sorami: "å°¼é»˜æ­¤ å°¬ å¾—è²¼ Kiåª½ç·š", desc: "æˆ‘çš„è¡Œææ²’æœ‰å‡ºä¾†", category: "æ©Ÿå ´", vocab: [{jp: "è·ç‰©", reading: "Nimotsu", mean: "è¡Œæ"}] },
                { id: 12, jp: "ãƒã‚¹ä¹—ã‚Šå ´ã¯ã©ã“ã§ã™ã‹", romaji: "Basu noriba wa doko desu ka", kana: "ã°ã™ ã®ã‚Šã° ã¯ ã©ã“ ã§ã™ ã‹", sorami: "å·´è˜‡ ãƒãƒ¼é‡Œå·´", desc: "å·´å£«ç«™åœ¨å“ªè£¡ï¼Ÿ", category: "äº¤é€š", vocab: [{jp: "ãƒã‚¹", reading: "Basu", mean: "å·´å£«"}] },
                { id: 13, jp: "ã“ã®é›»è»Šã¯æ–°å®¿ã«è¡Œãã¾ã™ã‹", romaji: "Kono densha wa Shinjuku ni ikimasu ka", kana: "ã“ã® ã§ã‚“ã—ã‚ƒ ã¯ ã—ã‚“ã˜ã‚…ã ã« ã„ãã¾ã™ ã‹", sorami: "å£è«¾ é›»ç å“‡...", desc: "é€™ç­è»Šå»æ–°å®¿å—ï¼Ÿ", category: "äº¤é€š", vocab: [{jp: "é›»è»Š", reading: "Densha", mean: "é›»è»Š"}] },
                { id: 14, jp: "åˆ‡ç¬¦ã‚’ãªãã—ã¾ã—ãŸ", romaji: "Kippu o nakushimashita", kana: "ãã£ã· ã‚’ ãªãã—ã¾ã—ãŸ", sorami: "Kiå™— å–” é‚£å“­æ´—åª½å¸Œå¡”", desc: "ç¥¨ä¸è¦‹äº†", category: "äº¤é€š", vocab: [{jp: "åˆ‡ç¬¦", reading: "Kippu", mean: "è»Šç¥¨"}] },
                { id: 15, jp: "ã‚¿ã‚¯ã‚·ãƒ¼ã‚’å‘¼ã‚“ã§ãã ã•ã„", romaji: "Takushii o yonde kudasai", kana: "ãŸãã—ãƒ¼ ã‚’ ã‚ˆã‚“ã§ ãã ã•ã„", sorami: "Taxi å–” ç”¨å¾— å“­æ‰“è³½", desc: "è«‹å¹«æˆ‘å«è¨ˆç¨‹è»Š", category: "äº¤é€š", vocab: [{jp: "ã‚¿ã‚¯ã‚·ãƒ¼", reading: "Takushii", mean: "è¨ˆç¨‹è»Š"}] },
                { id: 16, jp: "è·¯ç·šå›³ã¯ã‚ã‚Šã¾ã™ã‹", romaji: "Rosenzu wa arimasu ka", kana: "ã‚ã›ã‚“ãš ã¯ ã‚ã‚Šã¾ã™ ã‹", sorami: "ç¾…ä»™èŒ² å“‡ é˜¿å“©åª½è˜‡ å¡", desc: "æœ‰è·¯ç·šåœ–å—ï¼Ÿ", category: "äº¤é€š", vocab: [{jp: "åœ°å›³", reading: "Chizu", mean: "åœ°åœ–"}] },
                { id: 17, jp: "æ¬¡ã®é§…ã¯ã©ã“ã§ã™ã‹", romaji: "Tsugi no eki wa doko desu ka", kana: "ã¤ã ã® ãˆã ã¯ ã©ã“ ã§ã™ ã‹", sorami: "æ¬¡åŸº è«¾ A-Ki å“‡ è±†å£", desc: "ä¸‹ä¸€ç«™æ˜¯å“ªè£¡ï¼Ÿ", category: "äº¤é€š", vocab: [{jp: "æ¬¡", reading: "Tsugi", mean: "ä¸‹ä¸€å€‹"}] },
                { id: 18, jp: "é™ã‚Šã‚‹é§…ã‚’é–“é•ãˆã¾ã—ãŸ", romaji: "Oriru eki o machigaemashita", kana: "ãŠã‚Šã‚‹ ãˆã ã‚’ ã¾ã¡ãŒãˆã¾ã—ãŸ", sorami: "æ­é‡Œé­¯ A-Ki å–” éº»å‰å°¬Aåª½å¸Œå¡”", desc: "æˆ‘ä¸‹éŒ¯ç«™äº†", category: "äº¤é€š", vocab: [{jp: "é™ã‚Šã‚‹", reading: "Oriru", mean: "ä¸‹è»Š"}] },
                { id: 19, jp: "çµ‚é›»ã¯ä½•æ™‚ã§ã™ã‹", romaji: "Shuuden wa nanji desu ka", kana: "ã—ã‚…ã†ã§ã‚“ ã¯ ãªã‚“ã˜ ã§ã™ ã‹", sorami: "ä¿®é›» å“‡ é›£æ©Ÿ å¾—æ­» å¡", desc: "æœ«ç­è»Šå¹¾é»ï¼Ÿ", category: "äº¤é€š", vocab: [{jp: "çµ‚é›»", reading: "Shuuden", mean: "æœ«ç­è»Š"}] },
                { id: 20, jp: "æŒ‡å®šå¸­ã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Shiteiseki o onegaishimasu", kana: "ã—ã¦ã„ã›ã ã‚’ ãŠã­ãŒã„ã—ã¾ã™", sorami: "å¸è²¼å¸­K å–” æ­å…§è©²æ´—åª½è˜‡", desc: "è«‹çµ¦æˆ‘æŒ‡å®šå¸­", category: "äº¤é€š", vocab: [{jp: "å¸­", reading: "Seki", mean: "åº§ä½"}] },
                { id: 21, jp: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Chekkuin o onegaishimasu", kana: "ã¡ã‡ã£ãã„ã‚“ ã‚’ ãŠã­ãŒã„ã—ã¾ã™", sorami: "åˆ‡è‹¦å°", desc: "æˆ‘è¦è¾¦ç†å…¥ä½", category: "ä½å®¿", vocab: [{jp: "äºˆç´„", reading: "Yoyaku", mean: "é ç´„"}] },
                { id: 22, jp: "è·ç‰©ã‚’é ã‹ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹", romaji: "Nimotsu o azukatte moraemasu ka", kana: "ã«ã‚‚ã¤ ã‚’ ã‚ãšã‹ã£ã¦ ã‚‚ã‚‰ãˆã¾ã™ ã‹", sorami: "é˜¿èŒ²å¡è²¼ æ‘©æ‹‰Aåª½è˜‡", desc: "å¯ä»¥å¯„æ”¾è¡Œæå—ï¼Ÿ", category: "ä½å®¿", vocab: [{jp: "é ã‹ã‚‹", reading: "Azukaru", mean: "ä¿ç®¡"}] },
                { id: 23, jp: "Wi-Fiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½•ã§ã™ã‹", romaji: "Wi-Fi no pasuwaado wa nan desu ka", kana: "ã‚ã„ãµãã„ ã® ã±ã™ã‚ãƒ¼ã© ã¯ ãªã‚“ ã§ã™ ã‹", sorami: "PassæŒ–å¤š", desc: "Wi-Fi å¯†ç¢¼æ˜¯å¤šå°‘ï¼Ÿ", category: "ä½å®¿", vocab: [{jp: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", reading: "Pasuwaado", mean: "å¯†ç¢¼"}] },
                { id: 24, jp: "æœé£Ÿã¯ä½•æ™‚ã‹ã‚‰ã§ã™ã‹", romaji: "Choushoku wa nanji kara desu ka", kana: "ã¡ã‚‡ã†ã—ã‚‡ã ã¯ ãªã‚“ã˜ ã‹ã‚‰ ã§ã™ ã‹", sorami: "ç§‹ä¿®è‹¦ å“‡ é›£æ©Ÿ", desc: "æ—©é¤å¹¾é»é–‹å§‹ï¼Ÿ", category: "ä½å®¿", vocab: [{jp: "æœé£Ÿ", reading: "Choushoku", mean: "æ—©é¤"}] },
                { id: 25, jp: "ãŠæ¹¯ãŒå‡ºã¾ã›ã‚“", romaji: "Oyu ga demasen", kana: "ãŠã‚† ãŒ ã§ã¾ã›ã‚“", sorami: "æ­U å°¬ å¾—åª½ç·š", desc: "æ²’æœ‰ç†±æ°´", category: "ä½å®¿", vocab: [{jp: "ãŠæ¹¯", reading: "Oyu", mean: "ç†±æ°´"}] },
                { id: 26, jp: "éƒ¨å±‹ãŒå¯’ã„ã§ã™", romaji: "Heya ga samui desu", kana: "ã¸ã‚„ ãŒ ã•ã‚€ã„ ã§ã™", sorami: "é»‘äº å°¬ è–©å§†ä¸€", desc: "æˆ¿é–“å¾ˆå†·", category: "ä½å®¿", vocab: [{jp: "éƒ¨å±‹", reading: "Heya", mean: "æˆ¿é–“"}] },
                { id: 27, jp: "ã‚¿ã‚ªãƒ«ã‚’ãã ã•ã„", romaji: "Taoru o kudasai", kana: "ãŸãŠã‚‹ ã‚’ ãã ã•ã„", sorami: "å¥—é­¯ å–” å“­æ‰“è³½", desc: "è«‹çµ¦æˆ‘æ¯›å·¾", category: "ä½å®¿", vocab: [{jp: "ã‚¿ã‚ªãƒ«", reading: "Taoru", mean: "æ¯›å·¾"}] },
                { id: 28, jp: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¯ä½•æ™‚ã§ã™ã‹", romaji: "Chekkuauto wa nanji desu ka", kana: "ã¡ã‡ã£ãã‚ã†ã¨ ã¯ ãªã‚“ã˜ ã§ã™ ã‹", sorami: "Check Out å“‡", desc: "å¹¾é»é€€æˆ¿ï¼Ÿ", category: "ä½å®¿", vocab: [{jp: "æ™‚é–“", reading: "Jikan", mean: "æ™‚é–“"}] },
                { id: 29, jp: "è¿‘ãã«ã‚³ãƒ³ãƒ“ãƒ‹ã¯ã‚ã‚Šã¾ã™ã‹", romaji: "Chikaku ni konbini wa arimasu ka", kana: "ã¡ã‹ã ã« ã“ã‚“ã³ã« ã¯ ã‚ã‚Šã¾ã™ ã‹", sorami: "ä¸ƒå¡å“­ å°¼ Konæ¯”å°¼", desc: "é™„è¿‘æœ‰è¶…å•†å—ï¼Ÿ", category: "ä½å®¿", vocab: [{jp: "è¿‘ã", reading: "Chikaku", mean: "é™„è¿‘"}] },
                { id: 30, jp: "é™ã‹ãªéƒ¨å±‹ãŒã„ã„ã§ã™", romaji: "Shizuka na heya ga ii desu", kana: "ã—ãšã‹ ãª ã¸ã‚„ ãŒ ã„ã„ ã§ã™", sorami: "è¥¿èŒ²å¡ é‚£ é»‘äº", desc: "æˆ‘æƒ³è¦å®‰éœçš„æˆ¿é–“", category: "ä½å®¿", vocab: [{jp: "é™ã‹", reading: "Shizuka", mean: "å®‰éœ"}] },
                { id: 31, jp: "ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹", romaji: "Osusume wa nan desu ka", kana: "ãŠã™ã™ã‚ ã¯ ãªã‚“ ã§ã™ ã‹", sorami: "æ­è˜‡è˜‡å¦¹", desc: "æœ‰æ¨è–¦çš„å—ï¼Ÿ", category: "é¤å»³", vocab: [{jp: "ãŠã™ã™ã‚", reading: "Osusume", mean: "æ¨è–¦"}] },
                { id: 32, jp: "ãŠæ°´ã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Omizu o onegaishimasu", kana: "ãŠã¿ãš ã‚’ ãŠã­ãŒã„ã—ã¾ã™", sorami: "æ­å’ªèŒ²", desc: "è«‹çµ¦æˆ‘æ°´", category: "é¤å»³", vocab: [{jp: "æ°´", reading: "Mizu", mean: "æ°´"}] },
                { id: 33, jp: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Okaikei o onegaishimasu", kana: "ãŠã‹ã„ã‘ã„ ã‚’ ãŠã­ãŒã„ã—ã¾ã™", sorami: "æ­é–‹K", desc: "éº»ç…©çµå¸³", category: "çµå¸³", vocab: [{jp: "ä¼šè¨ˆ", reading: "Kaikei", mean: "çµå¸³"}] },
                { id: 34, jp: "ã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹", romaji: "Kaado wa tsukaemasu ka", kana: "ã‹ãƒ¼ã© ã¯ ã¤ã‹ãˆã¾ã™ ã‹", sorami: "å¡å¤š å“‡ æ­¤å¡Aåª½è˜‡", desc: "å¯ç”¨ä¿¡ç”¨å¡å—ï¼Ÿ", category: "çµå¸³", vocab: [{jp: "ã‚«ãƒ¼ãƒ‰", reading: "Kaado", mean: "å¡ç‰‡"}] },
                { id: 35, jp: "è¾›ãã—ãªã„ã§ãã ã•ã„", romaji: "Karaku shinaide kudasai", kana: "ã‹ã‚‰ã ã—ãªã„ã§ ãã ã•ã„", sorami: "å¡æ‹‰å“­ å¸å¥ˆå¾—", desc: "è«‹ä¸è¦åšå¤ªè¾£", category: "é¤å»³", vocab: [{jp: "è¾›ã„", reading: "Karai", mean: "è¾£"}] },
                { id: 36, jp: "ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã§", romaji: "Teikuauto de", kana: "ã¦ã„ãã‚ã†ã¨ ã§", sorami: "Take Out", desc: "æˆ‘è¦å¤–å¸¶", category: "é¤å»³", vocab: [{jp: "æŒã¡å¸°ã‚Š", reading: "Mochikaeri", mean: "å¤–å¸¶"}] },
                { id: 37, jp: "äºˆç´„ã—ã¦ã„ã¾ã™", romaji: "Yoyaku shite imasu", kana: "ã‚ˆã‚„ã ã—ã¦ ã„ã¾ã™", sorami: "å„ªé›…å“­ å¸è²¼", desc: "æˆ‘æœ‰é ç´„", category: "é¤å»³", vocab: [{jp: "äºˆç´„", reading: "Yoyaku", mean: "é ç´„"}] },
                { id: 38, jp: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãŒã‚ã‚Šã¾ã™", romaji: "Arerugii ga arimasu", kana: "ã‚ã‚Œã‚‹ããƒ¼ ãŒ ã‚ã‚Šã¾ã™", sorami: "é˜¿è•¾é­¯G", desc: "æˆ‘æœ‰éæ•", category: "é¤å»³", vocab: [{jp: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼", reading: "Arerugii", mean: "éæ•"}] },
                { id: 39, jp: "ç¦ç…™å¸­ãŒã„ã„ã§ã™", romaji: "Kinenseki ga ii desu", kana: "ãã‚“ãˆã‚“ã›ã ãŒ ã„ã„ ã§ã™", sorami: "Kinç…™å¸­", desc: "æˆ‘è¦ç¦è¸å¸­", category: "é¤å»³", vocab: [{jp: "ç¦ç…™", reading: "Kinen", mean: "ç¦è¸"}] },
                { id: 40, jp: "ã¨ã¦ã‚‚ç¾å‘³ã—ã‹ã£ãŸã§ã™", romaji: "Totemo oishikatta desu", kana: "ã¨ã¦ã‚‚ ãŠã„ã—ã‹ã£ãŸ ã§ã™", sorami: "é€è²¼æ‘¸ æ­ä¸€è¥¿å¡å¡”", desc: "éå¸¸å¥½åƒ", category: "é¤å»³", vocab: [{jp: "ç¾å‘³ã—ã„", reading: "Oishii", mean: "å¥½åƒ"}] },
                { id: 41, jp: "è©¦ç€ã—ã¦ã‚‚ã„ã„ã§ã™ã‹", romaji: "Shichaku shite mo ii desu ka", kana: "ã—ã¡ã‚ƒã ã—ã¦ ã‚‚ ã„ã„ ã§ã™ ã‹", sorami: "æ´—æ°è‹¦", desc: "å¯ä»¥è©¦ç©¿å—ï¼Ÿ", category: "è³¼ç‰©", vocab: [{jp: "è©¦ç€", reading: "Shichaku", mean: "è©¦ç©¿"}] },
                { id: 42, jp: "å…ç¨ã«ãªã‚Šã¾ã™ã‹", romaji: "Menzei ni narimasu ka", kana: "ã‚ã‚“ãœã„ ã« ãªã‚Šã¾ã™ ã‹", sorami: "å…è³Š", desc: "å¯ä»¥é€€ç¨…å—ï¼Ÿ", category: "è³¼ç‰©", vocab: [{jp: "å…ç¨", reading: "Menzei", mean: "å…ç¨…"}] },
                { id: 43, jp: "è¢‹ã¯ã„ã‚Šã¾ã›ã‚“", romaji: "Fukuro wa irimasen", kana: "ãµãã‚ ã¯ ã„ã‚Šã¾ã›ã‚“", sorami: "ç¦å£ å“‡ ä¼Šæ‹‰å¥ˆ", desc: "ä¸ç”¨è¢‹å­", category: "è³¼ç‰©", vocab: [{jp: "è¢‹", reading: "Fukuro", mean: "è¢‹å­"}] },
                { id: 44, jp: "ã“ã‚Œã®æ–°ã—ã„ã®ã¯ã‚ã‚Šã¾ã™ã‹", romaji: "Kore no atarashii no wa arimasu ka", kana: "ã“ã‚Œ ã® ã‚ãŸã‚‰ã—ã„ ã® ã¯ ã‚ã‚Šã¾ã™ ã‹", sorami: "é˜¿å¡”æ‹‰å¸ NO", desc: "æœ‰æ–°çš„å—ï¼Ÿ", category: "è³¼ç‰©", vocab: [{jp: "æ–°ã—ã„", reading: "Atarashii", mean: "æ–°"}] },
                { id: 45, jp: "ã¡ã‚‡ã£ã¨è¦‹ã¦ã‚‹ã ã‘ã§ã™", romaji: "Chotto miteru dake desu", kana: "ã¡ã‚‡ã£ã¨ ã¿ã¦ã‚‹ ã ã‘ ã§ã™", sorami: "ç§‹å· ç±³è²¼é­¯ é”K", desc: "æˆ‘åªæ˜¯çœ‹çœ‹", category: "è³¼ç‰©", vocab: [{jp: "è¦‹ã‚‹", reading: "Miru", mean: "çœ‹"}] },
                { id: 46, jp: "ã“ã‚Œã‚’ãã ã•ã„", romaji: "Kore o kudasai", kana: "ã“ã‚Œ ã‚’ ãã ã•ã„", sorami: "å£å…§ å–” å“­æ‰“è³½", desc: "æˆ‘è¦é€™å€‹", category: "è³¼ç‰©", vocab: [{jp: "ã“ã‚Œ", reading: "Kore", mean: "é€™å€‹"}] },
                { id: 47, jp: "å¤§ãã„ã‚µã‚¤ã‚ºã¯ã‚ã‚Šã¾ã™ã‹", romaji: "Ookii saizu wa arimasu ka", kana: "ãŠãŠãã„ ã•ã„ãš ã¯ ã‚ã‚Šã¾ã™ ã‹", sorami: "æ­Ki Size", desc: "æœ‰å¤§ä¸€é»çš„å—ï¼Ÿ", category: "è³¼ç‰©", vocab: [{jp: "å¤§ãã„", reading: "Ookii", mean: "å¤§"}] },
                { id: 48, jp: "å°ã•ã„ã‚µã‚¤ã‚ºã¯ã‚ã‚Šã¾ã™ã‹", romaji: "Chiisai saizu wa arimasu ka", kana: "ã¡ã„ã•ã„ ã•ã„ãš ã¯ ã‚ã‚Šã¾ã™ ã‹", sorami: "ä¸ƒè³½ Size", desc: "æœ‰å°ä¸€é»çš„å—ï¼Ÿ", category: "è³¼ç‰©", vocab: [{jp: "å°ã•ã„", reading: "Chiisai", mean: "å°"}] },
                { id: 49, jp: "é•ã†è‰²ã¯ã‚ã‚Šã¾ã™ã‹", romaji: "Chigau iro wa arimasu ka", kana: "ã¡ãŒã† ã„ã‚ ã¯ ã‚ã‚Šã¾ã™ ã‹", sorami: "ä¸ƒå°¬å±‹ ä¾ç¾…", desc: "æœ‰åˆ¥çš„é¡è‰²å—ï¼Ÿ", category: "è³¼ç‰©", vocab: [{jp: "è‰²", reading: "Iro", mean: "é¡è‰²"}] },
                { id: 50, jp: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆç”¨ã§ã™", romaji: "Purezento you desu", kana: "ã·ã‚Œãœã‚“ã¨ ã‚ˆã† ã§ã™", sorami: "Present å„ª", desc: "é€™æ˜¯è¦é€ç¦®çš„", category: "è³¼ç‰©", vocab: [{jp: "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ", reading: "Purezento", mean: "ç¦®ç‰©"}] },
                { id: 51, jp: "æ°—åˆ†ãŒæ‚ªã„ã§ã™", romaji: "Kibun ga warui desu", kana: "ãã¶ã‚“ ãŒ ã‚ã‚‹ã„ ã§ã™", sorami: "Kiä¸æ© å°¬ ç“¦é­¯ä¸€", desc: "æˆ‘ä¸èˆ’æœ", category: "ç·Šæ€¥", vocab: [{jp: "æ°—åˆ†", reading: "Kibun", mean: "æ„Ÿè¦º"}] },
                { id: 52, jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹", romaji: "Toire wa doko desu ka", kana: "ã¨ã„ã‚Œ ã¯ ã©ã“ ã§ã™ ã‹", sorami: "æ‹–è¡£è•¾", desc: "å»æ‰€åœ¨å“ªï¼Ÿ", category: "ç·Šæ€¥", vocab: [{jp: "ãƒˆã‚¤ãƒ¬", reading: "Toire", mean: "å»æ‰€"}] },
                { id: 53, jp: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’ãªãã—ã¾ã—ãŸ", romaji: "Pasupooto o nakushimashita", kana: "ã±ã™ã½ãƒ¼ã¨ ã‚’ ãªãã—ã¾ã—ãŸ", sorami: "Passæ³¢å¤š", desc: "è­·ç…§ä¸è¦‹äº†", category: "ç·Šæ€¥", vocab: [{jp: "ãªãã™", reading: "Nakusu", mean: "éºå¤±"}] },
                { id: 54, jp: "æ—¥æœ¬èªãŒã‚ã‹ã‚Šã¾ã›ã‚“", romaji: "Nihongo ga wakarimasen", kana: "ã«ã»ã‚“ã” ãŒ ã‚ã‹ã‚Šã¾ã›ã‚“", sorami: "ä½ ç´…è±† å°¬ å“‡å’–å“©åª½ç·š", desc: "æˆ‘ä¸æ‡‚æ—¥æ–‡", category: "ç·Šæ€¥", vocab: [{jp: "ã‚ã‹ã‚‹", reading: "Wakaru", mean: "æ‡‚"}] },
                { id: 55, jp: "è–¬å±€ã¯ã©ã“ã§ã™ã‹", romaji: "Yakkyoku wa doko desu ka", kana: "ã‚„ã£ãã‚‡ã ã¯ ã©ã“ ã§ã™ ã‹", sorami: "äºQåº«", desc: "è—¥å±€åœ¨å“ªè£¡ï¼Ÿ", category: "ç·Šæ€¥", vocab: [{jp: "è–¬å±€", reading: "Yakkyoku", mean: "è—¥å±€"}] },
                { id: 56, jp: "è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„", romaji: "Keisatsu o yonde kudasai", kana: "ã‘ã„ã•ã¤ ã‚’ ã‚ˆã‚“ã§ ãã ã•ã„", sorami: "Kè–©æ­¤ å–” ç”¨å¾—", desc: "è«‹å«è­¦å¯Ÿ", category: "ç·Šæ€¥", vocab: [{jp: "è­¦å¯Ÿ", reading: "Keisatsu", mean: "è­¦å¯Ÿ"}] },
                { id: 57, jp: "æ•‘æ€¥è»Šã‚’å‘¼ã‚“ã§ãã ã•ã„", romaji: "Kyuukyuusha o yonde kudasai", kana: "ãã‚…ã†ãã‚…ã†ã—ã‚ƒ ã‚’ ã‚ˆã‚“ã§ ãã ã•ã„", sorami: "QQè¦", desc: "è«‹å«æ•‘è­·è»Š", category: "ç·Šæ€¥", vocab: [{jp: "æ•‘æ€¥è»Š", reading: "Kyuukyuusha", mean: "æ•‘è­·è»Š"}] },
                { id: 58, jp: "è²¡å¸ƒã‚’ç›—ã¾ã‚Œã¾ã—ãŸ", romaji: "Saifu o nusumaremashita", kana: "ã•ã„ãµ ã‚’ ã¬ã™ã¾ã‚Œã¾ã—ãŸ", sorami: "è³½å¤« å–” åŠªè˜‡é¦¬è•¾", desc: "éŒ¢åŒ…è¢«å·äº†", category: "ç·Šæ€¥", vocab: [{jp: "ç›—ã‚€", reading: "Nusumu", mean: "å·"}] },
                { id: 59, jp: "å¤§ä½¿é¤¨ã¯ã©ã“ã§ã™ã‹", romaji: "Taishikan wa doko desu ka", kana: "ãŸã„ã—ã‹ã‚“ ã¯ ã©ã“ ã§ã™ ã‹", sorami: "å¤ªè¥¿çœ‹", desc: "å¤§ä½¿é¤¨åœ¨å“ªï¼Ÿ", category: "ç·Šæ€¥", vocab: [{jp: "å¤§ä½¿é¤¨", reading: "Taishikan", mean: "å¤§ä½¿é¤¨"}] },
                { id: 60, jp: "åŠ©ã‘ã¦ãã ã•ã„", romaji: "Tasukete kudasai", kana: "ãŸã™ã‘ã¦ ãã ã•ã„", sorami: "å¡”è˜‡Kè²¼", desc: "è«‹æ•‘æ•‘æˆ‘", category: "ç·Šæ€¥", vocab: [{jp: "åŠ©ã‘ã‚‹", reading: "Tasukeru", mean: "æ•‘åŠ©"}] }
            ],
            practice: [
                // Basic
                { id: 'p1', title: "ä¾¿åˆ©å•†åº—", desc: "åº—å“¡è©¢å•æ˜¯å¦åŠ ç†±", npc: "ãŠå¼å½“ã€æ¸©ã‚ã¾ã™ã‹ï¼Ÿ", npc_mean: "ä¾¿ç•¶è¦åŠ ç†±å—ï¼Ÿ", target: "ã¯ã„ã€ãŠé¡˜ã„ã—ã¾ã™ã€‚", target_mean: "æ˜¯çš„ï¼Œéº»ç…©ä½ äº†ã€‚", keywords: ["ã¯ã„", "ãŠé¡˜ã„ã—ã¾ã™"] },
                { id: 'p2', title: "é¤å»³é»é¤", desc: "è©¢å•æ˜¯å¦æœ‰å¤–èªèœå–®", npc: "ã”æ³¨æ–‡ã¯ãŠæ±ºã¾ã‚Šã§ã™ã‹ï¼Ÿ", npc_mean: "è«‹å•æ±ºå®šå¥½è¦é»ä»€éº¼äº†å—ï¼Ÿ", target: "è‹±èªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", target_mean: "è«‹å•æœ‰è‹±æ–‡èœå–®å—ï¼Ÿ", keywords: ["è‹±èª", "ãƒ¡ãƒ‹ãƒ¥ãƒ¼"] },
                // Transport
                { id: 'p3', title: "è¨ˆç¨‹è»Š", desc: "å‘ŠçŸ¥å¸æ©Ÿç›®çš„åœ°", npc: "ã©ã¡ã‚‰ã¾ã§è¡Œã‹ã‚Œã¾ã™ã‹ï¼Ÿ", npc_mean: "è«‹å•è¦å»å“ªè£¡ï¼Ÿ", target: "ã“ã®ä½æ‰€ã¾ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚", target_mean: "è«‹è¼‰æˆ‘åˆ°é€™å€‹åœ°å€ã€‚", keywords: ["ä½æ‰€", "ãŠé¡˜ã„ã—ã¾ã™"] },
                { id: 'p4', title: "å•è·¯", desc: "è©¢å•è»Šç«™ä½ç½®", npc: "ä½•ã‹ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿ", npc_mean: "éœ€è¦å¹«å¿™å—ï¼Ÿ", target: "é§…ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", target_mean: "è«‹å•è»Šç«™åœ¨å“ªè£¡ï¼Ÿ", keywords: ["é§…", "ã©ã“"] },
                // Shopping
                { id: 'p5', title: "è—¥å¦åº—", desc: "å°‹æ‰¾æ„Ÿå†’è—¥", npc: "ä½•ã‹ãŠæ¢ã—ã§ã™ã‹ï¼Ÿ", npc_mean: "åœ¨æ‰¾ä»€éº¼å—ï¼Ÿ", target: "é¢¨é‚ªè–¬ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", target_mean: "è«‹å•æœ‰æ„Ÿå†’è—¥å—ï¼Ÿ", keywords: ["é¢¨é‚ª", "è–¬"] },
                { id: 'p6', title: "çµå¸³", desc: "ä½¿ç”¨äº¤é€šå¡ä»˜æ¬¾", npc: "ãŠæ”¯æ‰•ã„ã¯ï¼Ÿ", npc_mean: "æ€éº¼ä»˜æ¬¾ï¼Ÿ", target: "Suicaã§æ‰•ãˆã¾ã™ã‹ï¼Ÿ", target_mean: "å¯ä»¥ç”¨Suicaå—ï¼Ÿ", keywords: ["Suica", "æ‰•ãˆã¾ã™ã‹"] },
                // Dining
                { id: 'p7', title: "å’–å•¡å»³", desc: "é»å†°å’–å•¡", npc: "ã”æ³¨æ–‡ã‚’ã©ã†ãã€‚", npc_mean: "è«‹é»é¤ã€‚", target: "ã‚¢ã‚¤ã‚¹ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’ãã ã•ã„ã€‚", target_mean: "è«‹çµ¦æˆ‘å†°å’–å•¡ã€‚", keywords: ["ã‚¢ã‚¤ã‚¹", "ã‚³ãƒ¼ãƒ’ãƒ¼"] },
                { id: 'p8', title: "å±…é…’å±‹", desc: "é»ç”Ÿå•¤é…’", npc: "ãŠé£²ã¿ç‰©ã¯ï¼Ÿ", npc_mean: "è¦å–ä»€éº¼ï¼Ÿ", target: "ã¨ã‚Šã‚ãˆãšç”Ÿã§ã€‚", target_mean: "å…ˆä¾†æ¯ç”Ÿå•¤å§ã€‚", keywords: ["ç”Ÿ", "nama"] },
                // Hotel
                { id: 'p9', title: "é£¯åº—æ«ƒå°", desc: "å¯„æ”¾è¡Œæ", npc: "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚", npc_mean: "æ­¡è¿å…‰è‡¨ã€‚", target: "è·ç‰©ã‚’é ã‹ã£ã¦ãã ã•ã„ã€‚", target_mean: "è«‹å¹«æˆ‘ä¿ç®¡è¡Œæã€‚", keywords: ["è·ç‰©", "é ã‹ã£ã¦"] },
                { id: 'p10', title: "éºå¤±ç‰©", desc: "å°‹æ‰¾éŒ¢åŒ…", npc: "ã©ã†ã•ã‚Œã¾ã—ãŸã‹ï¼Ÿ", npc_mean: "æ€éº¼äº†å—ï¼Ÿ", target: "è²¡å¸ƒã‚’è½ã¨ã—ã¾ã—ãŸã€‚", target_mean: "æˆ‘å¼„ä¸ŸéŒ¢åŒ…äº†ã€‚", keywords: ["è²¡å¸ƒ", "è½ã¨ã—ã¾ã—ãŸ"] },
                // Life
                { id: 'p11', title: "å•å¤©æ°£", desc: "è©¢å•æ˜å¤©å¤©æ°£", npc: "æ˜æ—¥ã®äºˆå®šã¯ï¼Ÿ", npc_mean: "æ˜å¤©æœ‰ä»€éº¼è¨ˆç•«ï¼Ÿ", target: "æ˜æ—¥ã®å¤©æ°—ã¯ã©ã†ã§ã™ã‹ï¼Ÿ", target_mean: "æ˜å¤©çš„å¤©æ°£å¦‚ä½•ï¼Ÿ", keywords: ["å¤©æ°—", "ã©ã†"] },
                { id: 'p12', title: "æ‹ç…§", desc: "è«‹æ±‚å¹«å¿™æ‹ç…§", npc: "ï¼ˆç›®ãŒåˆã£ãŸï¼‰", npc_mean: "(çœ¼ç¥äº¤æœƒ)", target: "å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ", target_mean: "å¯ä»¥å¹«æˆ‘æ‹ç…§å—ï¼Ÿ", keywords: ["å†™çœŸ", "æ’®ã£ã¦"] },
                { id: 'p13', title: "æ­è¨•", desc: "ç¨±è®šå°æ–¹", npc: "ï¼ˆéš£ã«åº§ã£ãŸï¼‰", npc_mean: "(ååœ¨æ—é‚Š)", target: "ãã®æœã€ç´ æ•µã§ã™ã­ã€‚", target_mean: "é€™ä»¶è¡£æœå¾ˆå¥½çœ‹å‘¢ã€‚", keywords: ["æœ", "ç´ æ•µ"] },
                { id: 'p14', title: "æ›¸åº—", desc: "æ‰¾æ—…éŠæ›¸", npc: "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚", npc_mean: "æ­¡è¿å…‰è‡¨ã€‚", target: "æ—…è¡Œã®ã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", target_mean: "æ—…éŠæŒ‡å—åœ¨å“ªè£¡ï¼Ÿ", keywords: ["æ—…è¡Œ", "ã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯"] },
                { id: 'p15', title: "è¿·è·¯", desc: "å‘è­¦å¯Ÿå•è·¯", npc: "ã©ã†ã—ã¾ã—ãŸã‹ï¼Ÿ", npc_mean: "æ€éº¼äº†å—ï¼Ÿ", target: "é“ã«è¿·ã„ã¾ã—ãŸã€‚ã“ã“ã¯ã©ã“ã§ã™ã‹ï¼Ÿ", target_mean: "æˆ‘è¿·è·¯äº†ï¼Œé€™è£¡æ˜¯å“ªè£¡ï¼Ÿ", keywords: ["é“", "è¿·ã„ã¾ã—ãŸ"] }
            ],
            master: [
                { id: 'm1', situation: "æ‹’çµ•é‚€è«‹", casual: { text: "ã¡ã‚‡ã£ã¨éƒ½åˆãŒæ‚ªã„ã‚“ã ã€‚", audio: "ã¡ã‚‡ã£ã¨éƒ½åˆãŒæ‚ªã„ã‚“ã " }, polite: { text: "ã‚ã„ã«ãéƒ½åˆãŒã¤ãã¾ã›ã‚“ã§...", audio: "ã‚ã„ã«ãéƒ½åˆãŒã¤ãã¾ã›ã‚“ã§" }, tip: "æœ‹å‹é–“ç”¨ã€Œæ‚ªã„ã€ï¼›å°ä¸Šå¸ç”¨ã€Œã‚ã„ã«ãã€ç·©è¡ã€‚" },
                { id: 'm2', situation: "é“æ­‰ (é²åˆ°)", casual: { text: "ã”ã‚ã‚“ã€é…ã‚Œã‚‹ï¼", audio: "ã”ã‚ã‚“ã€é…ã‚Œã‚‹" }, polite: { text: "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€é…ã‚Œã¾ã™ã€‚", audio: "ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€é…ã‚Œã¾ã™" }, tip: "å•†å‹™å ´åˆå¿…é ˆç”¨æœ€é«˜ç´šçš„é“æ­‰ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€ã€‚" },
                { id: 'm3', situation: "è«‹æ±‚ç¨ç­‰", casual: { text: "ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã€‚", audio: "ã¡ã‚‡ã£ã¨å¾…ã£ã¦" }, polite: { text: "å°‘ã€…ãŠå¾…ã¡ã„ãŸã ã‘ã¾ã™ã‹ã€‚", audio: "å°‘ã€…ãŠå¾…ã¡ã„ãŸã ã‘ã¾ã™ã‹" }, tip: "ã€Œå¾…ã£ã¦ã€æ˜¯å‘½ä»¤å½¢ã€‚æ­£å¼å ´åˆè«‹ç”¨ã€Œå°‘ã€…ã€ä¸¦ç”¨ç–‘å•å¥ã€‚" },
                { id: 'm4', situation: "è¡¨é”åå°", casual: { text: "ãã‚Œã¯é•ã†ã‚ˆã€‚", audio: "ãã‚Œã¯é•ã†ã‚ˆ" }, polite: { text: "ãã®ç‚¹ã«ã¤ã„ã¦ã¯ã€ç•°è«–ãŒã”ã–ã„ã¾ã™ã€‚", audio: "ãã®ç‚¹ã«ã¤ã„ã¦ã¯ã€ç•°è«–ãŒã”ã–ã„ã¾ã™" }, tip: "å•†å‹™ä¸Šä¸ç›´æ¥èªªã€Œä¸ä¸€æ¨£ã€ï¼Œè€Œæ˜¯èªªã€Œé—œæ–¼é‚£é»ï¼Œæˆ‘æœ‰äº›ç•°è­°ã€ã€‚" },
                { id: 'm5', situation: "ç¢ºèªç†è§£", casual: { text: "ã‚ã‹ã£ãŸï¼Ÿ", audio: "ã‚ã‹ã£ãŸ" }, polite: { text: "ã”ç†è§£ã„ãŸã ã‘ã¾ã—ãŸã§ã—ã‚‡ã†ã‹ã€‚", audio: "ã”ç†è§£ã„ãŸã ã‘ã¾ã—ãŸã§ã—ã‚‡ã†ã‹" }, tip: "å°ä¸Šå¸æˆ–å®¢æˆ¶ï¼Œç¢ºèªå°æ–¹æ˜¯å¦ç†è§£æ™‚è¦éå¸¸å°å¿ƒï¼Œç”¨ã€Œã”ç†è§£ã€ä¸¦ç”¨æ•¬èªçµå°¾ã€‚" },
                { id: 'm6', situation: "é›»è©±æ‡‰å° (ä¸åœ¨ä½å­ä¸Š)", casual: { text: "ä»Šã€ã„ãªã„ã‚ˆã€‚", audio: "ä»Šã€ã„ãªã„ã‚ˆ" }, polite: { text: "ãŸã ã„ã¾å¸­ã‚’å¤–ã—ã¦ãŠã‚Šã¾ã™ã€‚", audio: "ãŸã ã„ã¾å¸­ã‚’å¤–ã—ã¦ãŠã‚Šã¾ã™" }, tip: "æ¥è½å…¬å¸é›»è©±æ™‚ï¼ŒåŒäº‹ä¸åœ¨ä¸èƒ½èªªã€Œã„ãªã„ã€ï¼Œè¦èªªã€Œå¸­ã‚’å¤–ã—ã¦ãŠã‚Šã¾ã™ã€ã€‚" },
                { id: 'm7', situation: "è¡¨é”æ„Ÿè¬", casual: { text: "ã‚ã‚ŠãŒã¨ã†ï¼", audio: "ã‚ã‚ŠãŒã¨ã†" }, polite: { text: "èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚", audio: "èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™" }, tip: "åŠ ä¸Šã€Œèª ã«ã€èƒ½å¤§å¹…æå‡æ„Ÿè¬çš„èª æ„èˆ‡æ­£å¼æ„Ÿã€‚" },
                { id: 'm8', situation: "è«‹æ±‚å¹«å¿™", casual: { text: "æ‰‹ä¼ã£ã¦ã€‚", audio: "æ‰‹ä¼ã£ã¦" }, polite: { text: "ãŠåŠ›æ·»ãˆã‚’ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹ã€‚", audio: "ãŠåŠ›æ·»ãˆã‚’ã„ãŸã ã‘ã¾ã™ã§ã—ã‚‡ã†ã‹" }, tip: "ã€ŒãŠåŠ›æ·»ãˆã€æ˜¯è«‹æ±‚å”åŠ©çš„é«˜ç´šèªªæ³•ï¼Œéå¸¸æœ‰æ•™é¤Šã€‚" },
                { id: 'm9', situation: "åˆæ¬¡è¦‹é¢", casual: { text: "ã‚ˆã‚ã—ãï¼", audio: "ã‚ˆã‚ã—ã" }, polite: { text: "ãŠç›®ã«ã‹ã‹ã‚Œã¦å…‰æ „ã§ã™ã€‚", audio: "ãŠç›®ã«ã‹ã‹ã‚Œã¦å…‰æ „ã§ã™" }, tip: "å°å°Šè²´çš„äººåˆæ¬¡è¦‹é¢ï¼Œç”¨ã€Œèƒ½è¦‹åˆ°æ‚¨æ·±æ„Ÿæ¦®å¹¸ã€ã€‚" },
                { id: 'm10', situation: "é€åˆ¥", casual: { text: "ã¾ãŸã­ï¼", audio: "ã¾ãŸã­" }, polite: { text: "ä»Šå¾Œã®ã”æ´»èºã‚’ãŠç¥ˆã‚Šç”³ã—ä¸Šã’ã¾ã™ã€‚", audio: "ä»Šå¾Œã®ã”æ´»èºã‚’ãŠç¥ˆã‚Šç”³ã—ä¸Šã’ã¾ã™" }, tip: "é›¢è·æˆ–ç•¢æ¥­æ™‚ï¼Œç¥ç¦å°æ–¹å‰ç¨‹ä¼¼éŒ¦çš„æ­£å¼èªªæ³•ã€‚" }
            ],
            quotes: [
                { jp: "ç¶™ç¶šã¯åŠ›ãªã‚Š", reading: "Keizoku wa chikara nari", mean: "å …æŒå°±æ˜¯åŠ›é‡" },
                { jp: "ä¸€æœŸä¸€ä¼š", reading: "Ichigo Ichie", mean: "ä¸€ç”Ÿåªæœ‰ä¸€æ¬¡çš„ç›¸é‡" },
                { jp: "ä¸ƒè»¢ã³å…«èµ·ã", reading: "Nanakorobi Yaoki", mean: "è·Œå€’ä¸ƒæ¬¡ï¼Œçˆ¬èµ·ä¾†å…«æ¬¡ (ç™¾æŠ˜ä¸æ’“)" },
                { jp: "æ—¥æ—¥æ˜¯å¥½æ—¥", reading: "Nichi nichi kore koujitsu", mean: "æ¯ä¸€å¤©éƒ½æ˜¯å¥½æ—¥å­" }
            ],
            lucky: {
                colors: ["æ¡œè‰² (æ«»èŠ±ç²‰)", "è‹¥è‰è‰² (å«©ç¶ )", "ç‘ ç’ƒè‰² (æ·±è—)", "å±±å¹è‰² (é‡‘é»ƒ)", "è—¤è‰² (æ·¡ç´«)", "ç”Ÿæˆã‚Š (ç±³ç™½)"],
                items: ["æ‰‹å¸•", "å¾¡å®ˆ", "ç­†è¨˜æœ¬", "ç†±èŒ¶", "æ‰‹éŒ¶", "ç¡¬å¹£", "è€³æ©Ÿ"]
            }
        };

        const STORAGE_KEY = 'hibi_app_state_v15';
        let state = { nickname: "", currentTab: 'travel', progress: 0, dailyGoal: 5, points: 0, streak: 0, lastLoginDate: null, history: [], currentCardIndex: 0, currentPracticeIndex: 0, masteredCards: [], srsData: {}, settings: { showRomaji: true, ttsSpeed: 0.65 }, omikujiData: null };
        let autoPlayInterval = null; let isAutoPlaying = false; let jpVoice = null;
        let user = null; let db = null; let auth = null; let isOffline = false; let appId = '';

        function getTodayString() { return new Date().toISOString().split('T')[0]; }
        function vibrate(ms) { try { if (navigator.vibrate) navigator.vibrate(ms); } catch (e) {} }

        function initApp() {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    const config = JSON.parse(__firebase_config);
                    const fbApp = initializeApp(config);
                    auth = getAuth(fbApp);
                    db = getFirestore(fbApp);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'hibi-demo';
                    
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        signInWithCustomToken(auth, __initial_auth_token).catch(e => console.warn('Token auth failed', e));
                    } else {
                        signInAnonymously(auth).catch(e => console.warn('Anon auth failed', e));
                    }

                    onAuthStateChanged(auth, (u) => {
                        if (u) { user = u; loadCloudData(); }
                    });
                } else { throw new Error("No config"); }
            } catch (e) {
                console.warn("Offline Mode", e);
                isOffline = true;
                loadState();
                document.getElementById('app-loading').classList.add('hidden');
                
                if (!state.nickname) {
                    document.getElementById('auth-screen').classList.remove('hidden');
                } else {
                    document.getElementById('main-app').classList.remove('hidden');
                }
            }
        }

        async function loadCloudData() {
            if(!user || isOffline) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'progress');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    state = { ...state, ...docSnap.data() };
                    checkDailyStreak();
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
            } catch(e) { console.error(e); loadState(); }
            updateUI();
            document.getElementById('app-loading').classList.add('hidden');
        }

        function loadState() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) state = { ...state, ...JSON.parse(saved) };
                checkDailyStreak();
            } catch (e) {}
            updateUI();
        }

        function checkDailyStreak() {
            const today = getTodayString();
            if(!state.lastLoginDate) { state.lastLoginDate = today; state.streak = 1; state.history=[today]; saveState(); return; }
            if (state.lastLoginDate !== today) {
                const d = Math.ceil(Math.abs(new Date(today) - new Date(state.lastLoginDate)) / (86400000));
                if (d === 1) { state.streak++; state.points += 50; } else if (d > 1) state.streak = 1;
                if (!state.history.includes(today)) state.history.push(today);
                state.progress = 0; state.lastLoginDate = today;
                saveState();
            }
            // Don't force omikuji here, let user click
        }

        function saveState() {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) {}
            if (user && db && !isOffline) { 
                setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'progress'), state).catch(e=>{});
                if(state.nickname) {
                     setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid), {
                        name: state.nickname,
                        score: state.points,
                        streak: state.streak
                    }).catch(e=>{});
                }
            }
            updateUI();
        }

        async function handleLogin() {
            const name = document.getElementById('input-nickname').value.trim();
            if(!name) return alert('è«‹è¼¸å…¥æš±ç¨±');
            state.nickname = name;
            if (!state.lastLoginDate) {
                state.lastLoginDate = getTodayString();
                state.streak = 1;
                state.history = [state.lastLoginDate];
                state.points = 0;
            }
            saveState(); // Saves immediately
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            updateUI();
        }

        async function fetchLeaderboard() {
            if(isOffline) {
                document.getElementById('leaderboard-list').innerHTML = '<div class="text-center text-muji-sub py-4">é›¢ç·šæ¨¡å¼ç„¡æ³•è®€å–æ’è¡Œæ¦œ</div>';
                return;
            }
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '<div class="text-center text-muji-sub py-4">è¼‰å…¥ä¸­...</div>';
            
            try {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard')); 
                const querySnapshot = await getDocs(q);
                let scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push(doc.data());
                });
                
                scores.sort((a, b) => b.score - a.score);
                scores = scores.slice(0, 10);
                
                list.innerHTML = scores.map((p, i) => `
                    <div class="flex items-center justify-between p-3 rounded-xl ${p.name===state.nickname ? 'bg-white border border-muji-green/50 shadow-sm' : 'border-b border-gray-100 last:border-0'}">
                        <div class="flex items-center gap-3">
                            <span class="font-bold w-6 text-center text-muji-sub">${i+1}</span>
                            <div class="flex flex-col">
                                <span class="font-medium text-muji-text text-sm">${p.name}</span>
                                <span class="text-[10px] text-muji-sub">é€£å‹ ${p.streak} æ—¥</span>
                            </div>
                        </div>
                        <span class="font-bold text-muji-gold text-sm">${p.score}</span>
                    </div>
                `).join('');
                
                if(scores.length === 0) list.innerHTML = '<div class="text-center text-muji-sub py-4">ç›®å‰ç„¡äººä¸Šæ¦œ</div>';
                
            } catch (e) {
                console.error("Fetch LB failed", e);
                list.innerHTML = '<div class="text-center text-red-300 py-4">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function handleCardResult(isCorrect) {
            const cid = DB.travel[state.currentCardIndex].id;
            let s = state.srsData[cid] || { level: 0, nextReview: 0 };
            if (isCorrect) { s.level++; state.points+=10; state.progress++; if(!state.masteredCards.includes(cid)) state.masteredCards.push(cid); showToast("âœ¨ ç†Ÿè¨˜ï¼", "bg-muji-green"); }
            else { s.level=0; showToast("ğŸ’ª ç¨å¾Œå†è¤‡ç¿’", "bg-muji-red"); }
            state.srsData[cid] = s; 
            state.currentCardIndex = (state.currentCardIndex + 1) % DB.travel.length;
            saveState();
            const inner = document.querySelector('.card-inner');
            if(inner) { inner.style.transition='none'; inner.classList.remove('rotate-y-180','animate-swipe-left','animate-swipe-right'); inner.style.transform=''; setTimeout(()=>inner.style.transition='all 0.5s ease',50); }
            renderCurrentCard();
        }

        function updateUI() {
            if(state.nickname) document.getElementById('user-badge').textContent = state.nickname;
            document.getElementById('header-points').textContent = state.points;
            document.getElementById('header-streak').textContent = state.streak;
            document.getElementById('goal-text').textContent = `${state.progress}/${state.dailyGoal}`;
            document.getElementById('goal-progress-ring').style.strokeDasharray = `${Math.min(100, (state.progress/state.dailyGoal)*100)}, 100`;
            document.getElementById('count-travel').textContent = `å…¨ ${DB.travel.length} å¥`;
            document.getElementById('count-practice').textContent = `å…¨ ${DB.practice.length} æƒ…å¢ƒ`;
            document.getElementById('count-master').textContent = `å…¨ ${DB.master.length} é¡Œ`;
            
            document.getElementById('toggle-romaji').checked = state.settings.showRomaji;
            document.getElementById('speed-slider').value = state.settings.ttsSpeed;
            document.getElementById('speed-val').textContent = state.settings.ttsSpeed;
            
            renderCurrentCard(); renderPractice(); renderMasterQuiz(); renderHeatmap();
        }

        function renderCurrentCard() {
            const d = DB.travel[state.currentCardIndex]; if(!d) return;
            document.getElementById('card-category').textContent = d.category;
            document.getElementById('card-desc').textContent = d.desc;
            document.getElementById('card-jp').textContent = d.jp;
            document.getElementById('card-kana').textContent = d.kana;
            document.getElementById('card-romaji').textContent = d.romaji;
            document.getElementById('card-romaji').style.opacity = state.settings.showRomaji ? '1' : '0';
            document.getElementById('card-sorami').textContent = "ğŸ’¡ ç©ºè€³ï¼š" + d.sorami;
            document.getElementById('bigtext-content').textContent = d.jp;
            document.getElementById('vocab-list').innerHTML = d.vocab.map(v => `<div class="flex justify-between items-center pb-2 border-b border-gray-100 last:border-0" onclick="playAudio('${v.jp}', event)"><span class="text-muji-text font-medium text-sm">${v.jp}</span><div class="text-right text-[10px] text-gray-400">${v.reading}<br>${v.mean}</div></div>`).join('');
            lucide.createIcons();
        }
        function renderPractice() {
            const d = DB.practice[state.currentPracticeIndex]; if(!d) return;
            document.getElementById('practice-title').textContent = d.title;
            document.getElementById('practice-desc').textContent = d.desc;
            document.getElementById('practice-npc-text').textContent = d.npc;
            document.getElementById('practice-npc-mean').textContent = d.npc_mean;
            document.getElementById('practice-target-text').textContent = d.target;
            document.getElementById('practice-target-mean').textContent = d.target_mean;
        }
        function renderMasterQuiz() {
            const c = document.getElementById('quiz-container'); const s = document.getElementById('master-search').value.toLowerCase(); c.innerHTML = '';
            const f = DB.master.filter(d => d.situation.toLowerCase().includes(s));
            if(f.length===0) c.innerHTML='<div class="text-center text-muji-sub py-8">ç„¡çµæœ</div>';
            f.forEach(d => { c.innerHTML += `<div class="bg-white rounded-2xl p-6 shadow-soft border border-muji-border mb-4"><div class="flex justify-between items-center mb-4"><span class="text-sm font-bold text-muji-sub">${d.situation}</span><i data-lucide="arrow-right-left" class="w-4 h-4 text-muji-sub"></i></div><div class="space-y-4"><div class="p-3 bg-gray-50 rounded-lg active:bg-gray-100 transition-colors" onclick="playAudio('${d.casual.audio}', event)"><p class="font-medium text-muji-text">${d.casual.text}</p><span class="text-[10px] text-muji-sub">Casual</span></div><div class="p-3 bg-muji-bg rounded-lg border border-muji-brown/30 active:bg-orange-50 transition-colors" onclick="playAudio('${d.polite.audio}', event)"><p class="font-medium text-muji-text">${d.polite.text}</p><span class="text-[10px] text-muji-sub">Polite</span></div></div></div>`; });
            lucide.createIcons();
        }
        function renderHeatmap() { const c=document.getElementById('heatmap-container'); if(c) { c.innerHTML=''; const t=new Date(); for(let i=6;i>=0;i--){ const d=new Date(t); d.setDate(t.getDate()-i); const s=d.toISOString().split('T')[0]; c.innerHTML+=`<div class="w-2 h-2 rounded-full transition-all ${state.history.includes(s)?'bg-muji-green':'bg-gray-200'}"></div>`; } } }

        function loadVoices() { if('speechSynthesis' in window) { const vs=window.speechSynthesis.getVoices(); jpVoice=vs.find(v=>v.lang.includes('ja'))||null; } }
        function playAudio(text, e) {
            if(e) e.stopPropagation();
            if('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'ja-JP'; u.rate = state.settings.ttsSpeed;
                if(jpVoice) u.voice = jpVoice; else loadVoices();
                window.speechSynthesis.speak(u);
            }
        }
        function playAudioCurrentCard(e) { playAudio(DB.travel[state.currentCardIndex].jp, e); }
        function toggleAutoPlay() {
            const btn=document.getElementById('btn-autoplay'); if(!btn) return;
            const txt=document.getElementById('text-autoplay');
            if(isAutoPlaying) {
                isAutoPlaying=false; clearTimeout(autoPlayInterval); window.speechSynthesis.cancel();
                if(txt) txt.textContent='è½æµ';
                btn.classList.remove('bg-muji-green','text-white'); btn.classList.add('text-muji-sub');
                document.getElementById('wrapper-icon-play').classList.remove('opacity-0');
                document.getElementById('wrapper-icon-pause').classList.add('opacity-0');
            } else {
                isAutoPlaying=true;
                if(txt) txt.textContent='æ’­æ”¾ä¸­';
                btn.classList.add('bg-muji-green','text-white'); btn.classList.remove('text-muji-sub');
                document.getElementById('wrapper-icon-play').classList.add('opacity-0');
                document.getElementById('wrapper-icon-pause').classList.remove('opacity-0');
                if(!jpVoice) loadVoices();
                playNextAuto();
            }
        }
        function playNextAuto() {
            if(!isAutoPlaying) return;
            const d=DB.travel[state.currentCardIndex];
            const u=new SpeechSynthesisUtterance(d.jp);
            u.lang='ja-JP'; u.rate=state.settings.ttsSpeed; if(jpVoice) u.voice=jpVoice;
            u.onend = () => { if(isAutoPlaying) autoPlayInterval = setTimeout(() => { state.currentCardIndex=(state.currentCardIndex+1)%DB.travel.length; renderCurrentCard(); playNextAuto(); }, 2500); };
            window.speechSynthesis.speak(u);
        }

        function flipCard(el) { el.querySelector('.card-inner').classList.toggle('rotate-y-180'); }
        function switchTab(t) { state.currentTab=t; document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.dataset.target===`view-${t}`)); document.querySelectorAll('.view-section').forEach(s=>s.classList.toggle('hidden',s.id!==`view-${t}`)); saveState(); }
        function nextPractice() { state.currentPracticeIndex=(state.currentPracticeIndex+1)%DB.practice.length; saveState(); }
        function showToast(m,c) { const t=document.getElementById('toast'); if(t){ t.innerHTML=m; t.className=`fixed top-24 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full text-sm font-medium opacity-100 transition-all duration-300 z-[99] shadow-float translate-y-0 text-white ${c}`; setTimeout(()=>{ t.classList.remove('opacity-100','translate-y-0'); t.classList.add('opacity-0','translate-y-[-10px]'); },2000); } }
        function resetAppDebug() { if(confirm('é‡ç½®ï¼Ÿ')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
        function showBigText(e) { e.stopPropagation(); document.getElementById('bigtext-modal').classList.remove('opacity-0','pointer-events-none'); }
        function closeBigText() { document.getElementById('bigtext-modal').classList.add('opacity-0','pointer-events-none'); }

        function showProfile() { 
            document.getElementById('profile-modal').classList.remove('opacity-0','pointer-events-none'); 
            document.getElementById('profile-streak').textContent = state.streak;
            document.getElementById('profile-total').textContent = state.masteredCards.length;
            
            const badgeContainer = document.getElementById('badge-container');
            badgeContainer.innerHTML = (state.streak>=3?`<div class="flex flex-col items-center p-2 bg-gray-50 rounded-xl"><i data-lucide="flame" class="text-red-400 w-6 h-6 mb-1"></i><span class="text-[10px] text-muji-sub">3é€£å‹</span></div>`:'') + (state.points>=100?`<div class="flex flex-col items-center p-2 bg-gray-50 rounded-xl"><i data-lucide="star" class="text-yellow-400 w-6 h-6 mb-1"></i><span class="text-[10px] text-muji-sub">ç™¾åˆ†</span></div>`:'');
            lucide.createIcons();
            fetchLeaderboard(); 
        }
        function closeProfile() { document.getElementById('profile-modal').classList.add('opacity-0','pointer-events-none'); }
        function showSettings() { document.getElementById('settings-modal').classList.remove('opacity-0','pointer-events-none'); document.getElementById('settings-content').classList.remove('scale-95'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('opacity-0','pointer-events-none'); document.getElementById('settings-content').classList.add('scale-95'); }
        function toggleRomajiSetting() { state.settings.showRomaji = !state.settings.showRomaji; saveState(); }
        function updateSpeed(v) { state.settings.ttsSpeed = parseFloat(v); document.getElementById('speed-val').textContent=v; saveState(); }
        function exportData() { navigator.clipboard.writeText(JSON.stringify(state)).then(()=>alert("å·²è¤‡è£½")); }
        function importData() { const d=prompt("è²¼ä¸Šä»£ç¢¼"); if(d) { try{ state=JSON.parse(d); saveState(); alert("æˆåŠŸ"); location.reload(); }catch(e){alert("ç„¡æ•ˆ");} } }
        function showShareModal() { document.getElementById('share-modal').classList.remove('opacity-0','pointer-events-none'); document.getElementById('share-modal-content').classList.add('scale-100'); setTimeout(generateShareImage,300); }
        function closeShareModal() { document.getElementById('share-modal').classList.add('opacity-0','pointer-events-none'); document.getElementById('share-modal-content').classList.remove('scale-100'); }
        function generateShareImage() { const c=document.getElementById('share-canvas'); const ctx=c.getContext('2d'); const w=c.width; const h=c.height; const d=DB.travel[state.currentCardIndex]; ctx.fillStyle='#FDFCFA'; ctx.fillRect(0,0,w,h); ctx.fillStyle='#FFF'; ctx.fillRect(40,40,w-80,h-160); ctx.textAlign='center'; ctx.fillStyle='#373C38'; ctx.font='bold 48px sans-serif'; ctx.fillText(d.jp,w/2,h/2-20); ctx.fillStyle='#888'; ctx.font='24px sans-serif'; ctx.fillText(d.desc,w/2,h/2+30); document.getElementById('loading-canvas').style.display='none'; }
        function downloadShareImage() { const l=document.createElement('a'); l.download='hibi.png'; l.href=document.getElementById('share-canvas').toDataURL(); l.click(); }
        async function shareProgress() { try { await navigator.share({title:'Hibi', text:'å­¸ç¿’æ—¥èªä¸­', url:window.location.href}); } catch(e){} }
        function addToCalendar() { window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=æ—¥æ—¥+Hibi&details=å­¸ç¿’æ—¥èª&recur=RRULE:FREQ=DAILY`, '_blank'); }
        function showHelp() { document.getElementById('help-modal').classList.remove('opacity-0','pointer-events-none'); document.getElementById('help-modal-content').classList.add('scale-100'); }
        function closeHelp() { document.getElementById('help-modal').classList.add('opacity-0','pointer-events-none'); document.getElementById('help-modal-content').classList.remove('scale-100'); }

        let rec; let isRec=false;
        function initSpeech() { const SR = window.SpeechRecognition || window.webkitSpeechRecognition; if(SR) { rec=new SR(); rec.lang='ja-JP'; rec.onresult=e=>{ const t=e.results[0][0].transcript; document.getElementById('transcript-text').textContent=t; if(e.results[0].isFinal) validateSpeech(t); }; rec.onend=()=>{ isRec=false; const fb=document.getElementById('feedback-area'); if(fb&&!fb.classList.contains('hidden')) updateRecordUI('idle'); }; } else { const b=document.getElementById('btn-record'); if(b) b.style.display='none'; } }
        function toggleRecording() { if(!rec) return alert('ä¸æ”¯æ´'); if(isRec) rec.stop(); else { rec.start(); document.getElementById('feedback-area').classList.remove('hidden'); document.getElementById('feedback-text').textContent="è½å–ä¸­..."; isRec=true; updateRecordUI('listening'); } }
        function validateSpeech(t) { const k=DB.practice[state.currentPracticeIndex].keywords; if(k.some(w=>t.toLowerCase().includes(w))) { updateRecordUI('success'); addPoints(20); } else updateRecordUI('retry'); }
        function updateRecordUI(s) { const b=document.getElementById('btn-record'); const t=document.getElementById('btn-record-text'); if(!b) return; if(s==='listening') { b.classList.replace('bg-muji-green','bg-muji-red'); t.textContent='åœæ­¢'; } else if(s==='success') { b.classList.replace('bg-muji-red','bg-muji-green'); t.textContent='è©¦è‘—èªª'; document.getElementById('feedback-text').textContent='å¤ªæ£’äº†ï¼'; } else { b.classList.replace('bg-muji-red','bg-muji-green'); t.textContent='è©¦è‘—èªª'; } }

        function drawOmikuji() {
            vibrate([50, 50, 50]);
            document.getElementById('omikuji-shaker').classList.add('animate-shake');
            setTimeout(() => {
                document.getElementById('omikuji-shaker').classList.remove('animate-shake');
                document.getElementById('omikuji-box-state').classList.add('hidden');
                const res = document.getElementById('omikuji-result-state');
                res.classList.remove('hidden');
                const f = ["å¤§å‰", "ä¸­å‰", "å°å‰", "å‰", "æœ«å‰"];
                const q = DB.quotes[Math.floor(Math.random() * DB.quotes.length)];
                const c = DB.lucky.colors[Math.floor(Math.random() * DB.lucky.colors.length)];
                const i = DB.lucky.items[Math.floor(Math.random() * DB.lucky.items.length)];
                
                const result = { text: f[Math.floor(Math.random()*f.length)], quote: q.jp+"\n"+q.mean, color: c, item: i };
                state.omikujiData = { date: getTodayString(), result: result };
                saveState();

                document.getElementById('omikuji-text').textContent = result.text;
                document.getElementById('omikuji-quote').textContent = result.quote;
                document.getElementById('omikuji-color').textContent = result.color;
                document.getElementById('omikuji-item').textContent = result.item;

                setTimeout(() => { res.classList.remove('opacity-0', 'scale-90'); res.classList.add('animate-unfold'); }, 100);
            }, 600);
        }
        function closeOmikuji() { document.getElementById('omikuji-modal').classList.add('opacity-0', 'pointer-events-none'); }
        function showOmikuji() { 
            const m=document.getElementById('omikuji-modal'); const b=document.getElementById('omikuji-box-state'); const r=document.getElementById('omikuji-result-state');
            if(!m) return;
            const today = getTodayString();
            if (state.omikujiData && state.omikujiData.date === today) {
                const d = state.omikujiData.result;
                document.getElementById('omikuji-text').textContent = d.text;
                document.getElementById('omikuji-quote').textContent = d.quote;
                document.getElementById('omikuji-color').textContent = d.color;
                document.getElementById('omikuji-item').textContent = d.item;
                b.classList.add('hidden'); r.classList.remove('hidden','opacity-0','scale-90'); r.classList.add('animate-unfold');
            } else {
                b.classList.remove('hidden'); r.classList.add('hidden','opacity-0'); r.classList.remove('animate-unfold');
            }
            m.classList.remove('opacity-0', 'pointer-events-none'); 
        }

        let tsX=0, tsY=0, isDrag=false, isScroll=false;
        const cc=document.getElementById('flashcard-container');
        if(cc) {
            cc.addEventListener('touchstart',e=>{ tsX=e.touches[0].clientX; tsY=e.touches[0].clientY; isDrag=true; isScroll=false; const inr=cc.querySelector('.card-inner'); if(inr) inr.style.transition='none'; }, {passive:false});
            cc.addEventListener('touchmove',e=>{ if(!isDrag) return; const dx=e.touches[0].clientX-tsX; const dy=e.touches[0].clientY-tsY; if(!isScroll) { if(Math.abs(dx)>Math.abs(dy)) e.preventDefault(); else { isScroll=true; return; } } if(isScroll) return; const inr=cc.querySelector('.card-inner'); if(inr) { inr.style.transform=`translateX(${dx}px) rotate(${dx*0.1}deg)`; if(dx>50) document.getElementById('hint-right').style.opacity=Math.min(1,(dx-50)/100); else if(dx<-50) document.getElementById('hint-left').style.opacity=Math.min(1,(-dx-50)/100); } }, {passive:false});
            cc.addEventListener('touchend',e=>{ isDrag=false; if(isScroll) return; const dx=e.changedTouches[0].clientX-tsX; const inr=cc.querySelector('.card-inner'); if(inr) { inr.style.transition='all 0.5s ease'; if(Math.abs(dx)>=100) { if(dx>0) { inr.classList.add('animate-swipe-right'); setTimeout(()=>handleCardResult(true),300); } else { inr.classList.add('animate-swipe-left'); setTimeout(()=>handleCardResult(false),300); } } else { inr.style.transform=''; document.getElementById('hint-left').style.opacity='0'; document.getElementById('hint-right').style.opacity='0'; } } });
        }

        function exposeGlobals() {
            window.handleLogin = handleLogin;
            window.handleCardResult = handleCardResult;
            window.playAudioCurrentCard = playAudioCurrentCard;
            window.playAudio = playAudio;
            window.toggleAutoPlay = toggleAutoPlay;
            window.flipCard = flipCard;
            window.switchTab = switchTab;
            window.nextPractice = nextPractice;
            window.renderMasterQuiz = renderMasterQuiz;
            window.showShareModal = showShareModal;
            window.closeShareModal = closeShareModal;
            window.downloadShareImage = downloadShareImage;
            window.shareProgress = shareProgress;
            window.addToCalendar = addToCalendar;
            window.showHelp = showHelp;
            window.closeHelp = closeHelp;
            window.toggleRecording = toggleRecording;
            window.resetAppDebug = resetAppDebug;
            window.drawOmikuji = drawOmikuji;
            window.closeOmikuji = closeOmikuji;
            window.showProfile = showProfile;
            window.closeProfile = closeProfile;
            window.showSettings = showSettings;
            window.closeSettings = closeSettings;
            window.toggleRomajiSetting = toggleRomajiSetting;
            window.updateSpeed = updateSpeed;
            window.exportData = exportData;
            window.importData = importData;
            window.showBigText = showBigText;
            window.closeBigText = closeBigText;
            window.showOmikuji = showOmikuji;
        }

        window.addEventListener('DOMContentLoaded', () => { 
            initApp(); exposeGlobals(); initSpeech(); lucide.createIcons(); switchTab(state.currentTab); 
            if ('speechSynthesis' in window) { loadVoices(); window.speechSynthesis.onvoiceschanged = loadVoices; }
        });
    </script>
</body>
</html>